---
title: "Norwegian citizen science data exploration"
author: "Wouter Koch, NBIC"

output:
  pdf_document: default
  word_document: default
  html_document: default
---


```{r setup, include=FALSE, echo=FALSE}
  library(dplyr)
  library(rasterVis)
  library(rgbif)
  library(sp)
  library(raster)
  library(ggplot2)
  
  source("exploration.R")
  
  country_code <- "NO"
  country_coordinates <- c(3500000, 3500000, 5500000, 5500000)
  country_map <- map_data("world", country_code)
  
  ## Season onsets for Værnes airport according to Norwegian Meteorological Institute
  spring <- as.Date("3-15",  format = "%m-%d") ## From Mar 15 
  summer <- as.Date("5-22",  format = "%m-%d")  ## From May 22
  fall <- as.Date("9-11",  format = "%m-%d")  ## From Sep 11
  winter <- as.Date("11-18",  format = "%m-%d")  ## From Nov 18
  
  sp::coordinates(country_map) <- ~long + lat
  sp::proj4string(country_map) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")
```

******

```{r read_data, include=FALSE, echo=FALSE}
  taxon <- rgbif::name_suggest(q='Larus', rank='Genus')
  
  gbif_filter <- list(
      paste('taxonKey =', taxon$key[1]),
      paste('country =', country_code),
      'datasetKey = b124e1e0-4755-430f-9eab-894f25a9b59c',
      'year = 2016',
      'hasCoordinate = TRUE',
      'hasGeospatialIssue = FALSE',
      type = "and")

  ao_data <- load_GBIF_data(gbif_filter)
  geostat_data <- load_GeoStat_data(country_code)

```


```{r grid, include=FALSE, echo=FALSE}
  gridsizeinkm <- 50
  
  grid <- get_grid(gridsizeinkm, country_coordinates)
  grid_10km <- get_grid(10, country_coordinates)

```


A test data exploration of some [Norwegian Species Observation Service](https://www.artsobservasjoner.no) data, obtained through [GBIF](https://www.gbif.org) (N = `r nrow(ao_data)`). 

Filtering on `r taxon['canonicalName']` observations, plotted below.


```{r map_per_species, echo=FALSE, message=FALSE}
  ggplot(as.data.frame(ao_data)) +
    annotation_map(as.data.frame(country_map), fill="gray70", colour="gray70") +
    geom_point(aes(x=decimalLongitude, y=decimalLatitude, color=species), size=.5, shape=20) +
    theme(panel.background = element_rect(fill="aliceblue"), legend.position = "none") +
    coord_map(projection = "gnomonic", orientation=c(60, 16, -5)) +
    xlab("Longitude") +
    ylab("Latitude") +
    facet_wrap(~ species)

```

Map for each `r taxon['canonicalName']` species in Norway


```{r rastermap_observations, message=FALSE, echo=FALSE}

  ao_data_rasterized <- raster::rasterize(spTransform(ao_data, CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")), grid, fun='count')
  
  country_map <- spTransform(country_map, CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs"))
  
  gplot(ao_data_rasterized) +
    coord_fixed() +
    annotation_map(as.data.frame(country_map), fill="gray40", colour="black") +
    geom_tile(aes(fill=log(value)), alpha=1) +
    annotation_map(as.data.frame(country_map), fill=NA, colour="black") +
    theme(panel.background = element_rect(fill="aliceblue"), legend.position = "right") +
    scale_fill_distiller(palette = "Spectral", na.value=NA) +
    guides(color = guide_legend(override.aes = list(size=4))) +
    # coord_map(projection = "gnomonic", orientation=c(60, 16, -5)) +
    xlab("Longitude") +
    ylab("Latitude") + 
    labs(title="Total observation density") +
    labs(subtitle=taxon['canonicalName']) +
    labs(caption = paste("Density map for all", taxon['canonicalName'], "observations in Norway, rasterized to", gridsizeinkm, "x", gridsizeinkm, "km cells."))

```


## Human population density
```{r map_human_population, messages=FALSE, echo=FALSE}
  pop_unrasterized <- raster::rasterize(geostat_data, grid_10km, "TOT_P", fun='sum')

  gplot(pop_unrasterized) +
    coord_fixed() +
    annotation_map(as.data.frame(country_map), fill="gray40", colour="black") +
    geom_tile(aes(fill=log(value)), alpha=1) +
    annotation_map(as.data.frame(country_map), fill=NA, colour="black") +
    theme(panel.background = element_rect(fill="aliceblue"), legend.position = "right") +
    scale_fill_distiller(palette = "Spectral", na.value=NA) +
    guides(color = guide_legend(override.aes = list(size=4))) +
    # coord_map(projection = "gnomonic", orientation=c(60, 16, -5)) +
    xlab("Longitude") +
    ylab("Latitude") +
    labs(fill = "Log population") +
    ggtitle("Human population density")
```

Log human population per square km in norway





```{r rastermap_human_population, messages=FALSE, echo=FALSE}

pop_rasterized <- raster::rasterize(geostat_data, grid, "TOT_P", fun='sum')

gplot(pop_rasterized) +
    coord_fixed() +
    annotation_map(as.data.frame(country_map), fill="gray40", colour="black") +
    geom_tile(aes(fill=log(value)), alpha=1) +
    annotation_map(as.data.frame(country_map), fill=NA, colour="black") +
    theme(panel.background = element_rect(fill="aliceblue"), legend.position = "right") +
    scale_fill_distiller(palette = "Spectral", na.value=NA) +
    guides(color = guide_legend(override.aes = list(size=4))) +
    # coord_map(projection = "gnomonic", orientation=c(60, 16, -5)) +
    xlab("Longitude") +
    ylab("Latitude") +
    labs(fill = "Log population") +
    ggtitle("Human population density")

```

The log human population per `r gridsizeinkm` x `r gridsizeinkm` km cs cell in Norway.


```{r scatterplot_per_capita, messages=FALSE, echo=FALSE}

  pop_rasterized.points <- as.data.frame(rasterToPoints(pop_rasterized, spatial=TRUE))[c("layer","x","y")]
  pop_rasterized.points <- plyr::rename(pop_rasterized.points, c("layer"="population"))
  ao_data_rasterized.points <- as.data.frame(rasterToPoints(ao_data_rasterized, spatial=TRUE))[c("ID","x","y")]
  ao_data_rasterized.points <- plyr::rename(ao_data_rasterized.points, c("ID"="observations"))
  
  num_vs_pop <- ao_data_rasterized.points %>% inner_join(pop_rasterized.points, by = c("x", "y"))
  
  # num_vs_pop <- subset(num_vs_pop, population<100000 & observations < 1000) 

  sp::coordinates(num_vs_pop) <- ~x + y
  sp::proj4string(num_vs_pop) <- CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")

  ggplot(as.data.frame(num_vs_pop), aes(x=population, y=observations)) +
    geom_point()+
    geom_smooth(method=lm)
```

The number of `r taxon['canonicalName']` in Norway per `r gridsizeinkm` x `r gridsizeinkm` km cs cells, versus the human population in those cells. R² of the linaer regression is `r summary(lm(observations ~ population, data=num_vs_pop))$r.squared`.


```{r rastermap_observations_per_capita, messages=FALSE, echo=FALSE}

num_vs_pop$percapita <- num_vs_pop$observations / num_vs_pop$population
num_vs_pop_rasterized <- raster::rasterize(num_vs_pop, grid, "percapita", fun='sum')

gplot(num_vs_pop_rasterized) +
    coord_fixed() +
    annotation_map(as.data.frame(country_map), fill="gray40", colour="black") +
    geom_tile(aes(fill=log(value)), alpha=1) +
    annotation_map(as.data.frame(country_map), fill=NA, colour="black") +
    theme(panel.background = element_rect(fill="aliceblue"), legend.position = "right") +
    scale_fill_distiller(palette = "Spectral", na.value=NA) +
    guides(color = guide_legend(override.aes = list(size=4))) +
    # coord_map(projection = "gnomonic", orientation=c(60, 16, -5)) +
    xlab("Longitude") +
    ylab("Latitude") +
    labs(fill = "Log observations") +
    ggtitle("Observations per capita")
```

The log number of `r taxon['canonicalName']` observations in Norway per capita within `r gridsizeinkm` x `r gridsizeinkm` km cells.


```{r rastermap_observations_relative_to_lm, messages=FALSE, echo=FALSE}

num_vs_pop <- as.data.frame(num_vs_pop)

B0 <- (summary(lm(observations ~ population, data=num_vs_pop))$coefficients)["(Intercept)","Estimate"]
B1 <- (summary(lm(observations ~ population, data=num_vs_pop))$coefficients)["population","Estimate"]

num_vs_pop$relativeToLM <- num_vs_pop$observations / (B0 + B1 * num_vs_pop$population)

sp::coordinates(num_vs_pop) <- ~x + y
sp::proj4string(num_vs_pop) <- CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")

num_vs_pop_rasterized_LM <- raster::rasterize(num_vs_pop, grid, "relativeToLM", fun='sum')

gplot(num_vs_pop_rasterized_LM) +
    coord_fixed() +
    annotation_map(as.data.frame(country_map), fill="gray40", colour="black") +
    geom_tile(aes(fill=log(value)), alpha=1) +
    annotation_map(as.data.frame(country_map), fill=NA, colour="black") +
    theme(panel.background = element_rect(fill="aliceblue"), legend.position = "right") +
    scale_fill_distiller(palette = "Spectral", na.value=NA) +
    guides(color = guide_legend(override.aes = list(size=4))) +
    # coord_map(projection = "gnomonic", orientation=c(60, 16, -5)) +
    xlab("Longitude") +
    ylab("Latitude") +
    labs(fill = "Log observations") +
    ggtitle("Observations relative to regression with human population")
```

The log number of `r taxon['canonicalName']` observations in Norway divided by the number predicted by the regression line (numberOfObservations = `r B0` + `r B1` * humanPopulation),  within `r gridsizeinkm` x `r gridsizeinkm` km cells.
